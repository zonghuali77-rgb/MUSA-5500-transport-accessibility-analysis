<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Global Bus Accessibility Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Global Bus Accessibility Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../website/index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../website/methods.html"> 
<span class="menu-text">Methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../website/results.html"> 
<span class="menu-text">Results</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cities" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Cities</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-cities">    
        <li>
    <a class="dropdown-item" href="../website/city_nyc.html">
 <span class="dropdown-text">New York City</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../website/city_sg.html">
 <span class="dropdown-text">Singapore</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../website/city_ams.html">
 <span class="dropdown-text">Amsterdam</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../website/city_sh.html">
 <span class="dropdown-text">Shanghai</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../website/data_sources.html"> 
<span class="menu-text">Data Sources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../website/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#global-bus-accessibility-analysis" id="toc-global-bus-accessibility-analysis" class="nav-link active" data-scroll-target="#global-bus-accessibility-analysis">Global Bus Accessibility Analysis</a>
  <ul class="collapse">
  <li><a href="#background-and-motivation" id="toc-background-and-motivation" class="nav-link" data-scroll-target="#background-and-motivation">Background and Motivation</a></li>
  <li><a href="#why-these-four-cities" id="toc-why-these-four-cities" class="nav-link" data-scroll-target="#why-these-four-cities">Why These Four Cities?</a></li>
  <li><a href="#city-bus-systems-in-context" id="toc-city-bus-systems-in-context" class="nav-link" data-scroll-target="#city-bus-systems-in-context">City Bus Systems in Context</a>
  <ul class="collapse">
  <li><a href="#new-york-city" id="toc-new-york-city" class="nav-link" data-scroll-target="#new-york-city">New York City</a></li>
  <li><a href="#singapore" id="toc-singapore" class="nav-link" data-scroll-target="#singapore">Singapore</a></li>
  <li><a href="#amsterdam" id="toc-amsterdam" class="nav-link" data-scroll-target="#amsterdam">Amsterdam</a></li>
  <li><a href="#shanghai" id="toc-shanghai" class="nav-link" data-scroll-target="#shanghai">Shanghai</a></li>
  </ul></li>
  <li><a href="#research-questions-and-objectives" id="toc-research-questions-and-objectives" class="nav-link" data-scroll-target="#research-questions-and-objectives">Research Questions and Objectives</a></li>
  <li><a href="#relation-to-urban-planning-and-policy" id="toc-relation-to-urban-planning-and-policy" class="nav-link" data-scroll-target="#relation-to-urban-planning-and-policy">Relation to Urban Planning and Policy</a></li>
  <li><a href="#how-to-use-this-website" id="toc-how-to-use-this-website" class="nav-link" data-scroll-target="#how-to-use-this-website">How to Use This Website</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Global Bus Accessibility Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="global-bus-accessibility-analysis" class="level1">
<h1>Global Bus Accessibility Analysis</h1>
<section id="background-and-motivation" class="level2">
<h2 class="anchored" data-anchor-id="background-and-motivation">Background and Motivation</h2>
<p>Public transport accessibility is a central concern in contemporary urban planning. A dense and well-distributed bus network can reduce car dependence, support social equity, and connect residents to jobs, education, and essential services. At the same time, many large cities worldwide are facing pressures from rapid urbanisation, climate change, and increasing socio-spatial inequality. Understanding where bus services are abundant – and where gaps remain – is therefore both a technical and a normative question.</p>
<p>This project investigates bus stop accessibility in four major metropolitan areas:</p>
<ul>
<li><strong>New York City (USA)</strong><br>
</li>
<li><strong>Singapore</strong><br>
</li>
<li><strong>Amsterdam (Netherlands)</strong><br>
</li>
<li><strong>Shanghai (China)</strong></li>
</ul>
<p>Together, these cities span different continents, governance regimes, urban forms, and data environments. Comparing them side by side allows us to see how different planning traditions and data infrastructures are reflected in the spatial patterns of bus service.</p>
</section>
<section id="why-these-four-cities" class="level2">
<h2 class="anchored" data-anchor-id="why-these-four-cities">Why These Four Cities?</h2>
</section>
<section id="city-bus-systems-in-context" class="level2">
<h2 class="anchored" data-anchor-id="city-bus-systems-in-context">City Bus Systems in Context</h2>
<p>Although this project focuses on bus stop locations rather than service operations, it is important to understand the broader context of each city’s bus system. The brief profiles below summarise key features that inform the interpretation of the spatial patterns.</p>
<section id="new-york-city" class="level3">
<h3 class="anchored" data-anchor-id="new-york-city">New York City</h3>
<p><img src="images/nyc_bus.jpg" class="img-fluid" alt="A New York City MTA bus in service"> <em>Image source: <a href="https://www.bloomberg.com/news/articles/2025-11-06/mamdani-s-free-nyc-buses-complicated-by-bond-paying-pledge?embedded-checkout=true">Bloomberg – Free NYC buses complicated by bond-paying pledge</a></em></p>
<p>New York City’s bus network is operated under <strong>MTA Regional Bus Operations (RBO)</strong>, which consolidates services provided by MTA New York City Bus and MTA Bus Company. Together they form one of the largest bus systems in the world, with a fleet of over 5,000 vehicles, more than 300 routes, and many services operating 24/7. The network includes local stopping routes, limited-stop and express lines, as well as Select Bus Service corridors that approximate bus rapid transit. Historically separate operating companies – including several private operators in Queens and express services from the outer boroughs – have gradually been integrated into a unified fare and scheduling system. As a result, the spatial footprint of bus stops reflects both legacy private franchises and later rationalisation efforts by the MTA.</p>
</section>
<section id="singapore" class="level3">
<h3 class="anchored" data-anchor-id="singapore">Singapore</h3>
<p><img src="images/sg_bus.jpg" class="img-fluid" alt="A public bus in Singapore"> <em>Image source: <a href="https://www.trapezegroup.eu/author/mikec/">Trapeze Group – Bus services in Singapore</a></em></p>
<p>Singapore’s bus system is <strong>highly structured and formally categorised</strong>. Routes are differentiated into trunk services linking major towns, feeder services circulating within neighbourhoods, express and peak-hour routes that skip lower-demand stops, short-trip variants of longer lines, special industrial services to Jurong and Tuas, cross-border services to Malaysia, and a range of niche services such as Resorts World Sentosa shuttles and privately operated “Scheme B” routes. Under the <strong>Bus Contracting Model</strong>, services are organised into packages and competitively tendered to different operators, while the Land Transport Authority plans the overall network. This institutional set-up tends to produce relatively systematic spacing of stops and strong coordination between buses and the MRT network.</p>
</section>
<section id="amsterdam" class="level3">
<h3 class="anchored" data-anchor-id="amsterdam">Amsterdam</h3>
<p><img src="images/ams_bus.jpg" class="img-fluid" alt="A GVB city bus in Amsterdam"> <em>Image source: <a href="https://www.sustainable-bus.com/electric-bus/gvb-amsterdam-takes-the-first-step-with-battery-electric-buses-in-the-city-center/">GVB Amsterdam takes the first step with battery-electric buses</a></em></p>
<p>In Amsterdam, buses <strong>complement an already dense tram and metro system</strong>. Within the municipality, city buses are mainly operated by GVB and serve outer neighbourhoods and corridors that are not covered by tram or metro. Regional bus companies such as Connexxion, EBS, and Transdev connect Amsterdam with surrounding towns and key visitor destinations in the wider region (for example the Waterland villages, Zaanse Schans, and Schiphol Airport). For visitors and commuters, the Amsterdam &amp; Region Travel Ticket provides integrated access to these services across operators. The result is a bus stop pattern that is strongly shaped by inter-operator coordination and the presence of multiple overlapping modes.</p>
</section>
<section id="shanghai" class="level3">
<h3 class="anchored" data-anchor-id="shanghai">Shanghai</h3>
<p><img src="images/sh_bus.jpg" class="img-fluid" alt="A city bus in Shanghai"> <em>Image source: <a href="https://www.thechinajourney.com/shanghai-travel-guide/#google_vignette">The China Journey – Shanghai travel guide</a></em></p>
<p>Shanghai’s bus network is <strong>large, multi-operator, and highly differentiated</strong>. More than ten bus companies operate roughly 1,600 routes that link the dense central districts with rapidly expanding suburban areas. Regular urban lines are numbered (roughly from 1 to the 900s), while additional labels distinguish cross-river and tunnel services, district and suburban routes, night buses, peak-hour express lines, and local shuttle services designed to solve the “last-kilometre” connection to metro stations and between major roads and residential communities. On most inner-city routes, stop announcements are made in Mandarin, Shanghainese, and English, reflecting the city’s multilingual context. This complex operational structure contributes to a very dense but spatially heterogeneous pattern of bus stops.</p>
<p>The cities were selected for three main reasons:</p>
<ol type="1">
<li><p><strong>Diverse planning and transit models</strong></p>
<ul>
<li><strong>New York City</strong> represents a large, polycentric North American metropolis with a long history of high-capacity transit (subway, commuter rail) and a dense but uneven bus network.<br>
</li>
<li><strong>Singapore</strong> is a compact city-state with a strongly integrated public transport system, where bus routes are carefully coordinated with the MRT network and land-use planning.<br>
</li>
<li><strong>Amsterdam</strong> exemplifies a European approach to sustainable mobility, with a combination of rail, tram, bus, and high levels of walking and cycling.<br>
</li>
<li><strong>Shanghai</strong> is a rapidly developed megacity where metro expansion and bus network restructuring have taken place at remarkable speed over the last two decades.</li>
</ul>
<p>These contrasting contexts offer a natural laboratory for exploring how bus stop patterns emerge under different planning paradigms.</p></li>
<li><p><strong>Variation in open data and data sources</strong></p>
<p>The four cities also differ in how transit and boundary data are made available:</p>
<ul>
<li>New York City and Singapore provide rich, curated datasets via open data portals.<br>
</li>
<li>Amsterdam publishes detailed administrative boundaries, while bus stops are obtained from OpenStreetMap.<br>
</li>
<li>Shanghai lacks comprehensive official open transit data, so OpenStreetMap, via the Overpass API, is used as the main bus stop source, and Simplemaps is used for municipal boundaries.</li>
</ul>
<p>This mix reflects the reality that urban researchers often rely on a combination of official and volunteered geographic information (VGI).</p></li>
<li><p><strong>Comparability as large global cities</strong></p>
<p>All four are <strong>large, economically significant cities</strong> with extensive public transport systems and substantial daily ridership. Comparing bus stop accessibility across them therefore speaks to broader questions about global urban mobility and spatial justice, rather than to small idiosyncratic cases.</p></li>
</ol>
</section>
</section>
<section id="research-questions-and-objectives" class="level2">
<h2 class="anchored" data-anchor-id="research-questions-and-objectives">Research Questions and Objectives</h2>
<p>The analysis is guided by four main questions:</p>
<ol type="1">
<li><strong>How dense are bus stop networks in each city?</strong><br>
</li>
<li><strong>What share of the urban area lies within a walkable distance (500 m) of a bus stop?</strong><br>
</li>
<li><strong>How are bus stops spatially distributed – clustered, even, or irregular – as reflected in kernel density surfaces and nearest-neighbour distances?</strong><br>
</li>
<li><strong>How might differences in planning approaches and data environments help explain the observed patterns?</strong></li>
</ol>
<p>The objectives are:</p>
<ul>
<li>To construct a <strong>transparent and reproducible geospatial workflow</strong> for analysing bus accessibility using open-source Python tools.<br>
</li>
<li>To produce <strong>comparable indicators</strong> of bus stop density, walking coverage, and spatial regularity across the four cities.<br>
</li>
<li>To generate <strong>maps and summary statistics</strong> that can support discussions on transit equity, network design, and the role of open data in urban research.</li>
</ul>
</section>
<section id="relation-to-urban-planning-and-policy" class="level2">
<h2 class="anchored" data-anchor-id="relation-to-urban-planning-and-policy">Relation to Urban Planning and Policy</h2>
<p>Although this is a data-driven exercise, the questions are rooted in urban planning debates:</p>
<ul>
<li><strong>Equity and inclusion</strong> – who benefits from high levels of bus service, and which neighbourhoods remain underserved?<br>
</li>
<li><strong>Multimodal integration</strong> – how do bus stop patterns complement or duplicate rail and metro networks?<br>
</li>
<li><strong>Street and land-use structure</strong> – how do built form and road layout shape feasible bus routing and stop spacing?<br>
</li>
<li><strong>Data and governance</strong> – how do different open data practices facilitate or constrain comparative research?</li>
</ul>
<p>The results should be read not as a definitive performance ranking of cities, but as a <strong>spatial diagnostic</strong> that helps planners and researchers ask better questions about transit provision and access.</p>
</section>
<section id="how-to-use-this-website" class="level2">
<h2 class="anchored" data-anchor-id="how-to-use-this-website">How to Use This Website</h2>
<ul>
<li>The <strong>Methods</strong> page describes the data sources and geospatial methods in more detail.<br>
</li>
<li>The <strong>Results</strong> page summarises cross-city comparisons of density, coverage, and spatial statistics.<br>
</li>
<li>The <strong>Cities</strong> menu provides dedicated pages for New York City, Singapore, Amsterdam, and Shanghai, including maps and interpretive comments.<br>
</li>
<li>The <strong>Data Sources</strong> page documents boundary and bus stop datasets and highlights limitations.<br>
</li>
<li>The <strong>About</strong> page introduces the author and situates the project in a broader academic context.</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>